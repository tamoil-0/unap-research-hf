name: Update Repositories (UNAP/UNSA)

on:
  schedule:
    # Ejecutar cada lunes a las 3 AM UTC (mensual aproximado)
    - cron: '0 3 * * 1'
  
  workflow_dispatch:
    inputs:
      force_full_reindex:
        description: 'Forzar reindexaciÃ³n completa'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.10'
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  HF_TOKEN: ${{ secrets.HF_TOKEN }}

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
      
      - name: Configure Git LFS
        run: |
          git lfs install
          git lfs pull
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check for new repositories (Harvest)
        id: harvest
        run: |
          echo "ðŸ” Harvesting new items from UNAP/UNSA..."
          python scripts/01.harvest_multi.py
          
          # Check if there are new items
          if [ -f "data/harvest_summary.json" ]; then
            NEW_COUNT=$(python -c "import json; print(json.load(open('data/harvest_summary.json'))['new_items'])")
            echo "new_items=$NEW_COUNT" >> $GITHUB_OUTPUT
            echo "âœ… Found $NEW_COUNT new items"
          else
            echo "new_items=0" >> $GITHUB_OUTPUT
            echo "âš ï¸ No harvest summary found"
          fi
      
      - name: Build semantic index (FAISS)
        if: steps.harvest.outputs.new_items > 0 || github.event.inputs.force_full_reindex == 'true'
        run: |
          echo "ðŸ§  Building semantic index with FAISS..."
          python scripts/02.semantic_indexer.py
          echo "âœ… FAISS index updated"
      
      - name: Cluster topics (HDBSCAN)
        if: steps.harvest.outputs.new_items > 0 || github.event.inputs.force_full_reindex == 'true'
        run: |
          echo "ðŸ“Š Clustering topics with HDBSCAN..."
          python scripts/03.build_topics_hdbscan.py
          echo "âœ… Topics clustered"
      
      - name: Commit and push changes
        if: steps.harvest.outputs.new_items > 0 || github.event.inputs.force_full_reindex == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add updated files
          git add models_semantic/
          git add data/
          
          # Create commit with details
          COMMIT_MSG="chore: automated repository update - $(date +'%Y-%m-%d')

          - New items: ${{ steps.harvest.outputs.new_items }}
          - Updated FAISS index
          - Updated topic clusters
          
          [skip ci]"
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit"
          else
            git commit -m "$COMMIT_MSG"
            git push origin main
            echo "âœ… Changes pushed to GitHub"
          fi
      
      - name: Push to Hugging Face Spaces
        if: steps.harvest.outputs.new_items > 0 || github.event.inputs.force_full_reindex == 'true'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Configure HF remote with token
          git remote remove hf || true
          git remote add hf https://tamoil13:$HF_TOKEN@huggingface.co/spaces/tamoil13/unap-research-ml
          
          # Push to HF Spaces
          git push hf main --force
          echo "âœ… Changes pushed to Hugging Face Spaces"
      
      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ“‹ Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **New items**: ${{ steps.harvest.outputs.new_items }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Force reindex**: ${{ github.event.inputs.force_full_reindex }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/harvest_summary.json" ]; then
            echo "### Harvest Details" >> $GITHUB_STEP_SUMMARY
            cat data/harvest_summary.json | python -m json.tool >> $GITHUB_STEP_SUMMARY
          fi
